---
title: 'W271 Lab 2: CO2 Present'
geometry: margin=1in
output:
  github_document: default
---

```{r load packages, echo = FALSE, message = FALSE}
library(tidyverse)
library(tsibble)
library(latex2exp)
theme_set(theme_minimal())
knitr::opts_chunk$set(dpi = 1000)

# additional packages
library(dplyr)
library(Hmisc)
library(patchwork)
library(forecast)
library(stargazer)
library(gridExtra)

## To laod All data sets in the book "Forecasting: principles and practice"
# by Rob J Hyndman and George Athanasopoulos
# install.packages("fpp3")
# install.packages("fpp2")

library(fpp3)
library(fpp2)
```

## (3 points) Task 0b: Introduction 
Following up on the 1997 publication on the study on the time-dependent atmospheric $CO_2$ build up. Since then, atmospheric $CO_2$ has increases from 360 to 420 ppm.


## (3 points) Task 1b: Create a modern data pipeline for Mona Loa CO2 data.

```{r data-load-pipeline}
# read csv from link and save it as a data file
co2_present <- read.csv(
  "https://gml.noaa.gov/webdata/ccgg/trends/co2/co2_mm_mlo.csv",
  sep = ",", skip = 56
)
# write.csv(co2_present, "./co2_present.csv")
head(co2_present)
```
```{r create-time-component}
co2_present_ts <- co2_present %>%
  select(year, month, average, deseasonalized) %>%
  mutate(time_index = yearmonth(lubridate::make_datetime(
    year = year,
    month = month
  ))) %>%
  tsibble::as_tsibble(index = time_index) %>%
  drop_na()

head(co2_present_ts)
```

```{r}
# basic information about the data
print(sum(is.na(co2_present_ts)))
# print(start(co2_present$time_index))
# print(end(co2_present$time_index))
```

```{r time-plot}
co2_present_ts %>%
  ggplot() +
  aes(x = time_index, y = average) +
  geom_line(color = "steelblue") +
  labs(
    title = TeX(r'(Present Date Monthly Mean $CO_2$)'),
    subtitle = 'The "Keeling Curve"',
    x = "Month and Year",
    y = TeX(r'($CO_2$ parts per million)')
  )
```


```{r}
p1 <- co2_present_ts %>%
  autoplot(average, colour = "gray") +
  geom_line(aes(y = deseasonalized), colour = "#D55E00") +
  labs(
    y = "CO2 ppm", x = "Time",
    title = "Present Date Monthly Mean CO2"
  )
p1
```

```{r decomposition}
dcmp <- co2_present_ts %>%
  model(classical_decomposition(average, type = "additive"))

components(dcmp) %>% autoplot()
```
> There seem to be a noticible non-linear relationship to the trend since 1970. However, the seasonality effect remains periodic and unchanged.

```{r ETSDA plots}
co2_present_ts <- co2_present_ts %>%
  mutate(average_4_month_MA = slider::slide_dbl(average, mean,
    .before = 3, .after = 0, .complete = TRUE
  ))

# plot the series
series <- co2_present_ts %>%
  ggplot() +
  geom_point(aes(x = time_index, y = average)) +
  geom_line(aes(x = time_index, y = average_4_month_MA), color = "red") +
  ggtitle("CO2 Level Time Series") +
  xlab("Date") +
  ylab("CO2 (ppm)")

# plot of histogram
histogram <- co2_present_ts %>%
  ggplot(aes(x = average)) +
  geom_histogram(color = "black", fill = "white", binswidth = 10) +
  ggtitle("CO2 Level Histogram") +
  xlab("CO2 (ppm)")


# plot acf and pacf
acf <- ggAcf(co2_present_ts$average, level = 0.95)
pacf <- ggPacf(co2_present_ts$average, level = 0.95)

(series | histogram) /
  (acf | pacf)
```
>'Non-Stationary, Trends in Features applying 1st order diff'


## (1 point) Task 2b: Compare linear model forecasts against realized CO2

Descriptively compare realized atmospheric CO2 levels to those predicted by your forecast from a linear time model in 1997 (i.e. "Task 2a"). (You do not need to run any formal tests for this task.) 

```{r, original-linear-model}
# Fit a linear time trend model examine the characteristics of the residuals
mod.lm1 <- lm(co2 ~ time(co2))
summary(mod.lm1)
plot(mod.lm1, which = c(1, 1))

# creating new data
# forecast for n steps
# new_data <- seq()
# lin.forecast <- forecast::forecast(mod.lm1, level=c(95), h=110*12)
# lin.forecast
```

## (1 point) Task 3b: Compare ARIMA models forecasts against realized CO2  


Descriptively compare realized atmospheric CO2 levels to those predicted by your forecast from the ARIMA model that you fitted in 1997 (i.e. "Task 3a"). Describe how the Keeling Curve evolved from 1997 to the present. 


## (3 points) Task 4b: Evaluate the performance of 1997 linear and ARIMA models 

In 1997 you made predictions about the first time that CO2 would cross 420 ppm. How close were your models to the truth? 

After reflecting on your performance on this threshold-prediction task, continue to use the weekly data to generate a month-average series from 1997 to the present, and compare the overall forecasting performance of your models from Parts 2a and 3b over the entire period. (You should conduct formal tests for this task.) 

## (4 points) Task 5b: Train best models on present data

Seasonally adjust the weekly NOAA data, and split both seasonally-adjusted (SA) and non-seasonally-adjusted (NSA) series into training and test sets, using the last two years of observations as the test sets. For both SA and NSA series, fit ARIMA models using all appropriate steps. Measure and discuss how your models perform in-sample and (psuedo-) out-of-sample, comparing candidate models and explaining your choice. In addition, fit a polynomial time-trend model to the seasonally-adjusted series and compare its performance to that of your ARIMA model.

```{r first order diff ETSDA plot}
# plot the series
co2_present_ts$diff <- c(0, diff(co2_present_ts$average))

series <- co2_present_ts %>%
  ggplot(aes(x = time_index, y = diff)) +
  geom_line() +
  ggtitle("CO2 1st Order Difference Time Series") +
  xlab("Date") +
  ylab("CO2 (ppm)")

# plot of histogram
histogram <- co2_present_ts %>%
  ggplot(aes(x = diff)) +
  geom_histogram(color = "black", fill = "white", binswidth = 10) +
  ggtitle("CO2 1st Order Difference Histogram") +
  xlab("CO2 (ppm)")


# plot acf and pacf
acf <- ggAcf(pa$diff, level = 0.95)
pacf <- ggPacf(pa$diff, level = 0.95)

(series | histogram) /
  (acf | pacf)
```
> looks like white noise ...



## (3 points) Task Part 6b: How bad could it get?

With the non-seasonally adjusted data series, generate predictions for when atmospheric CO2 is expected to be at 420 ppm and 500 ppm levels for the first and final times (consider prediction intervals as well as point estimates in your answer). Generate a prediction for atmospheric CO2 levels in the year 2122. How confident are you that these will be accurate predictions?
