---
title: 'W271 Lab 2: CO2 Present'
geometry: margin=1in
output:
  github_document: default
---

```{r load packages, echo = FALSE, message = FALSE}
library(tidyverse)
library(tsibble)
library(latex2exp)
theme_set(theme_minimal())
knitr::opts_chunk$set(dpi = 1000)

# additional packages
library(dplyr)
library(Hmisc)
library(patchwork)
library(forecast)
library(stargazer)
library(gridExtra)
library(magrittr)

## To laod All data sets in the book "Forecasting: principles and practice"
# by Rob J Hyndman and George Athanasopoulos
# install.packages("fpp3")
# install.packages("fpp2")

library(fpp3)
library(fpp2)
```

## (3 points) Task 0b: Introduction 
Following up on the 1997 publication on the study on the time-dependent atmospheric $CO_2$ build up. Since then, atmospheric $CO_2$ has increases from 360 to 420 ppm. 

We are re-evaluating the models and forecasts from the 1997 paper, in an attempt to understand the current state of the atmosphere and the future of $CO_2$ levels.

## (3 points) Task 1b: Create a modern data pipeline for Mona Loa CO2 data.

```{r data-load-pipeline-from-website}
co2_present_raw <- read.csv("https://gml.noaa.gov/webdata/ccgg/trends/co2/co2_weekly_mlo.csv",
  sep = ",",
  skip = 51
)
head(co2_present_raw)
```

```{r create-time-component}
co2_present_raw <- co2_present_raw %>%
  select(year, month, day, average) %>%
  mutate(time_index = yearweek(
    paste(
      year,
      month,
      day,
      sep = "-"
    )
  ))

co2_present_raw %>%
  ggplot(aes(y = average, x = time_index)) +
  geom_line()
```

```{r eda: fill-the-missing-weekly-data-from-monthly}
co2_present_month <- read.csv(
  "https://gml.noaa.gov/webdata/ccgg/trends/co2/co2_mm_mlo.csv",
  sep = ",", skip = 56
)

co2_present_raw <- co2_present_raw %>%
  left_join(y = co2_present_month, by = c("year", "month")) %>%
  within(., value <- ifelse(average.x == -999.99, average.y, average.x))

co2_present <- co2_present_raw %>%
  dplyr::select(time_index, year, month, day, value) %>%
  tsibble::as_tsibble(index = time_index)

# basic information about the data
# head(co2_present)
# print(sum(is.na(co2_present)))
# print(start(co2_present$time_index))
# print(end(co2_present$time_index))
```


```{r time-plot}
co2_present %>%
  ggplot() +
  aes(x = time_index, y = value) +
  geom_line(color = "steelblue") +
  labs(
    title = TeX(r'(Present Date Monthly Mean $CO_2$)'),
    subtitle = 'The "Keeling Curve"',
    x = "Month and Year",
    y = TeX(r'($CO_2$ parts per million)')
  )
```

```{r CO2-ETSDA, echo = FALSE, warning=FALSE, message=FALSE, fig.align='center', out.width="65%", fig.cap="Atmospheric CO2 Level Time Series Overview"}
co2_enhanced <- co2_present %>%
  mutate(
    annual_growth = (value - lag(value, n = 52)) / lag(value, n = 52) * 100,
    log_value = log(value)
  )

# plot the annualized growth rate
p_3 <- co2_enhanced %>%
  ggplot() +
  aes(x = time_index, y = annual_growth) +
  geom_line(color = "steelblue") +
  labs(
    title = TeX(r'(Annualized Growth $CO_2$)'),
    subtitle = 'The "Keeling Curve"',
    x = "Month and Year",
    y = TeX(r'($CO_2$ Annualized Growth Rate)')
  ) +
  theme(plot.title = element_text(size = 10))

# plot the histogram
p_4 <- co2_enhanced %>%
  ggplot(aes(x = value)) +
  geom_histogram(binwidth = 1) +
  labs(title = TeX(r'(Histogram Monthly Mean $CO_2$)'), col = " blue") +
  xlab("Monthly Mean") +
  theme(plot.title = element_text(size = 10))
# scale_x_continuous(limits = c(0, 16), breaks = seq(1,16,2))


# Use additive method in STL decomposition
dcmp_add <- co2_enhanced %>%
  model(stl = STL(value))

# plot of time series
p_5_add <- components(dcmp_add) %>%
  as_tsibble() %>%
  autoplot(value, colour = "gray") +
  geom_line(aes(y = trend), colour = "#D55E00") +
  labs(
    y = TeX(r"($CO_2$ Annualized Growth Rate)"),
    x = "Month and Year",
    title = "Monthly Mean CO2"
  ) +
  theme(plot.title = element_text(size = 10))

# plot the components
p_6_add <- components(dcmp_add) %>%
  autoplot() + theme(plot.title = element_text(size = 10))

(p_5_add | p_3) / (p_4 | p_6_add)
```

## (1 point) Task 2b: Compare linear model forecasts against realized CO2

To be able to compare the observed weekly data with model forecasts, which were done using monthly series, we aggregated the weekly data to monthly data by taking all average for all the weeks in a month.

```{r generate-monthly-indexed-summary}
co2_present_monthly <- co2_present %>%
  index_by(month_index = ~ yearmonth(.)) %>%
  summarise(
    value = mean(value)
  ) %>%
  tsibble::as_tsibble(index = month_index) %>%
  drop_na()
```

```{r boxplot, echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', out.width="65%", fig.cap="Seasonality CO2 Level Monthly Distribution"}
# box plot
# todo: Do we need it?
co2_present_ts <- co2_present_monthly %>%
  select(month_index, value) %>%
  as.ts()

box <- boxplot(co2_present_ts ~ cycle(co2_present_ts, xlab = "Month", ylab = "CO2 (ppm)", main = "Monthly Mean CO2"))
```

```{r, original-linear-model}
# Fit a linear time trend model examine the characteristics of the residuals

mod.lm1 <- lm(co2 ~ time(co2))
mod.lm1

# creating new data
co2_new_date <- co2_present_monthly %>%
  mutate(date = as.Date(month_index), date_decimal = decimal_date(date)) %>%
  select(date_decimal, value) %>%
  as.ts()

lin_forecast <- forecast::forecast(mod.lm1, level = c(95), newdata = co2_new_date)

co2_present_monthly %>%
  ggplot() +
  # geom_line(aes(x = month_index, y = value), color = "steelblue") +
  geom_line(aes(x = co2_new_date$date, y = lin_forecast), color = "red")
```

## (1 point) Task 3b: Compare ARIMA models forecasts against realized CO2  


Descriptively compare realized atmospheric CO2 levels to those predicted by your forecast from the ARIMA model that you fitted in 1997 (i.e. "Task 3a"). Describe how the Keeling Curve evolved from 1997 to the present. 


## (3 points) Task 4b: Evaluate the performance of 1997 linear and ARIMA models 

In 1997 you made predictions about the first time that CO2 would cross 420 ppm. How close were your models to the truth? 

After reflecting on your performance on this threshold-prediction task, continue to use the weekly data to generate a month-average series from 1997 to the present, and compare the overall forecasting performance of your models from Parts 2a and 3b over the entire period. (You should conduct formal tests for this task.) 

```{r, cross-420-ppm}
co2_present %>%
  dplyr::filter(value >= 420) %>%
  head(1)
```

$CO_2$ crossed 420 ppm in the last week of April 2021. This is 10 years faster than the prediction made by the linear model in 1997. The ARIMA model predicted that $CO_2$ would cross 420 ppm by May 2031.

```{r, cross-420-ppm}
```

## (4 points) Task 5b: Train best models on present data

Seasonally adjust the weekly NOAA data, and split both seasonally-adjusted (SA) and non-seasonally-adjusted (NSA) series into training and test sets, using the last two years of observations as the test sets. For both SA and NSA series, fit ARIMA models using all appropriate steps. Measure and discuss how your models perform in-sample and (psuedo-) out-of-sample, comparing candidate models and explaining your choice. In addition, fit a polynomial time-trend model to the seasonally-adjusted series and compare its performance to that of your ARIMA model.

```{r first order diff ETSDA plot}
# plot the series
co2_present$diff <- c(0, diff(co2_present$value))

series <- co2_present %>%
  ggplot(aes(x = time_index, y = diff)) +
  geom_line() +
  ggtitle("CO2 1st Order Difference Time Series") +
  xlab("Date") +
  ylab("CO2 (ppm)")

# plot of histogram
histogram <- co2_present %>%
  ggplot(aes(x = diff)) +
  geom_histogram(color = "black", fill = "white", binwidth = 10) +
  ggtitle("CO2 1st Order Difference Histogram") +
  xlab("CO2 (ppm)")


# plot acf and pacf
acf <- ggAcf(co2_present$diff, ci = 0.95)
pacf <- ggPacf(co2_present$diff, ci = 0.95)

(series | histogram) /
  (acf | pacf)
```
> looks like white noise ...



## (3 points) Task Part 6b: How bad could it get?

With the non-seasonally adjusted data series, generate predictions for when atmospheric CO2 is expected to be at 420 ppm and 500 ppm levels for the first and final times (consider prediction intervals as well as point estimates in your answer). Generate a prediction for atmospheric CO2 levels in the year 2122. How confident are you that these will be accurate predictions?
